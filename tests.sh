#!/bin/bash

set -uo pipefail

announce_block() {
    local msg=("${@:1}")
    echo
    echo "=== $msg ========================="
}
expect() {
    local expected_exit_code=$1
    local cmd=("${@:2}")
    echo ">>>"
    echo ">>> Running command: '${cmd[*]}'"
    echo ">>>"
    "${cmd[@]}"
    local exit_code=$?
    if [ $exit_code -eq $expected_exit_code ]; then
        echo "... passed with code $exit_code"
        echo
    else
        echo "<<< Command failed with unexpected exit code $exit_code"
        exit 1
    fi
}

# TODO: create cover
# TODO: "*" and "/"

announce_block "create: ok"
expect 0 ./main.py create "s0 a1,10"
expect 0 ./main.py create "s0 a1,10" --path=./data/a.txt
expect 0 ./main.py create --path=./data/a.txt "s0 a1,10"
announce_block "create: err"
expect 2 ./main.py create
expect 2 ./main.py create other
expect 2 ./main.py create "s0 a1,10" other
expect 2 ./main.py create other "s0 a1,10"
expect 2 ./main.py create "s0 a1,10" --other="hi"
expect 2 ./main.py create other --other="hi"
expect 2 ./main.py create "s0 a1,10" other --other="hi"
expect 2 ./main.py create other "s0 a1,10" --other="hi"

announce_block "create/params: ok"
expect 0 ./main.py create "s0 a1,10"
expect 0 ./main.py create " s0 a1,10"
expect 0 ./main.py create "s0 a1,10 "
expect 0 ./main.py create " s0 a1,10 "
expect 0 ./main.py create "s0   a1,10"
expect 0 ./main.py create "s0
a1,10"
expect 0 ./main.py create "s0 a1,10 r+,1-99,10 r+,1-99,10"
expect 0 ./main.py create "  s0 a1,10 r+,1-99,10 r+,1-99,10"
expect 0 ./main.py create "s0 a1,10 r+,1-99,10 r+,1-99,10  "
expect 0 ./main.py create "  s0 a1,10    r+,1-99,10 r+,1-99,10  "
expect 0 ./main.py create " s0 a1,10    r+,1-99,10
r+,1-99,10  "
announce_block "create/params: err"
expect 2 ./main.py create "s0a1,10"
expect 2 ./main.py create "s0,a1,10"
expect 2 ./main.py create "s0 a1,10;"
expect 2 ./main.py create "s0_a1,10"
expect 2 ./main.py create "s0_a1,10x"
expect 2 ./main.py create "^s0 r+,1-99,10"
expect 2 ./main.py create "s0 r+,1-99,10^"
expect 2 ./main.py create "s0!r+,1-99,10"
expect 2 ./main.py create ".s0 r+,1-99,10"
expect 2 ./main.py create "s0 r+,1-99,10."
expect 2 ./main.py create "s0?c+,1-99,10"
expect 2 ./main.py create "s0 a1,10r+,1-99,10 r+,1-99,10"
expect 2 ./main.py create "s0 a1,10 r+,1-99,10c+,1-99,10"
expect 2 ./main.py create "s0 a1,10/r+,1-99,10 r+,1-99,10"
expect 2 ./main.py create "s0 a1,10 r+,1-99,10.c+,1-99,10"
expect 2 ./main.py create "?s0 a1,10 r+,1-99,10 r+,1-99,10"
expect 2 ./main.py create "s0 a1,10 r+,1-99,10 r+,1-99,10!"
expect 2 ./main.py create "s0 a1,10 r+,1-99,10 r+,1-99,10 !"
expect 2 ./main.py create "? s0 a1,10 r+,1-99,10 r+,1-99,10"
expect 2 ./main.py create " s0 a1,10 ___ r+,1-99,10 r+,1-99,10"

announce_block "create/params/start-number: ok"
expect 0 ./main.py create "s0 a1,10"
expect 0 ./main.py create "s1 a1,10"
expect 0 ./main.py create "s1.2 a1,10"
expect 0 ./main.py create "s-1 a1,10"
expect 0 ./main.py create "s-1.2 a1,10"
announce_block "create/params/start-number: err"
expect 2 ./main.py create "a1,10"
expect 2 ./main.py create "s a1,10"
expect 2 ./main.py create "0 a1,10"
expect 2 ./main.py create "d0 a1,10"

announce_block "create/params/seq_params: ok"
expect 0 ./main.py create "s0 a1,10"
expect 0 ./main.py create "s0 r+,1-99,10"
expect 0 ./main.py create "s0 r+,1-99,10"
announce_block "create/params/seq_params: err"
expect 2 ./main.py create "s0 a110"
expect 2 ./main.py create "s0 a1,10,"
expect 2 ./main.py create "s0 ,a0,10"
expect 2 ./main.py create "s0 ,a0,10,"
expect 2 ./main.py create "s0 r+1-9910"
expect 2 ./main.py create "s0 r+1-99,10"
expect 2 ./main.py create "s0 r+,1-99,10,"
expect 2 ./main.py create "s0 ,r+,1-99,10"
expect 2 ./main.py create "s0 ,r+,1-99,10,"
expect 2 ./main.py create "s0 r+1-9910"
expect 2 ./main.py create "s0 r+1-99,10"
expect 2 ./main.py create "s0 r+,1-99,10,"
expect 2 ./main.py create "s0 ,c+,1-99,10"
expect 2 ./main.py create "s0 ,c+,1-99,10,"
expect 2 ./main.py create "s0 a1,10x"
expect 2 ./main.py create "s0 xa0,10"
expect 2 ./main.py create "s0 xa0,10x"
expect 2 ./main.py create "s0 r+,1-99,10_"
expect 2 ./main.py create "s0 _r+,1-99,10"
expect 2 ./main.py create "s0 _r+,1-99,10_"
expect 2 ./main.py create "s0 r+,1-99,10?"
expect 2 ./main.py create "s0 ?c+,1-99,10"
expect 2 ./main.py create "s0 ?c+,1-99,10?"

announce_block "create/params/seq_params/kind: ok"
expect 0 ./main.py create "s0 a1,10"
expect 0 ./main.py create "s0 r+,1-99,10"
expect 0 ./main.py create "s0 r+,1-99,10"
announce_block "create/params/seq_params/kind: err"
expect 2 ./main.py create "s0 0,10"
expect 2 ./main.py create "s0 1,10"
expect 2 ./main.py create "s0 1.2,10"
expect 2 ./main.py create "s0 -1,10"
expect 2 ./main.py create "s0 -1.2,10"
expect 2 ./main.py create "s0 +,1-99,10"
expect 2 ./main.py create "s0 +,1-99,10"
expect 2 ./main.py create "s0 x0,10"
expect 2 ./main.py create "s0 x1,10"
expect 2 ./main.py create "s0 x1.2,10"
expect 2 ./main.py create "s0 x-1,10"
expect 2 ./main.py create "s0 x-1.2,10"
expect 2 ./main.py create "s0 x+,1-99,10"
expect 2 ./main.py create "s0 x+,1-99,10"

announce_block "create/params/seq_params/kind.arithmetic/diff: ok"
expect 0 ./main.py create "s0 a1,10"
expect 0 ./main.py create "s0 a1.2,10"
expect 0 ./main.py create "s0 a-1,10"
expect 0 ./main.py create "s0 a-1.2,10"
announce_block "create/params/seq_params/kind.arithmetic/diff: err"
expect 2 ./main.py create "s0 a0,10" # diff can't be 0
expect 2 ./main.py create "s0 a,10"
expect 2 ./main.py create "s0 ax,10"
expect 2 ./main.py create "s0 a1.x,10"
expect 2 ./main.py create "s0 ax.2,10"
expect 2 ./main.py create "s0 a-x,10"
expect 2 ./main.py create "s0 a-1.x,10"
expect 2 ./main.py create "s0 a-x.2,10"

announce_block "create/params/seq_params/kind.arithmetic/length: ok"
expect 0 ./main.py create "s0 a1,1"
expect 0 ./main.py create "s0 a1,15"
announce_block "create/params/seq_params/kind.arithmetic/length: err"
expect 2 ./main.py create "s0 a1,"
expect 2 ./main.py create "s0 a1,0"
expect 2 ./main.py create "s0 a1,1.2"
expect 2 ./main.py create "s0 a1,-1"
expect 2 ./main.py create "s0 a1,-1.2"
expect 2 ./main.py create "s0 a1,x"

announce_block "create/params/seq_params/kind.arithmetic/roundtrip: ok"
expect 0 ./main.py create "s0 a1,1:<"
expect 0 ./main.py create "s0 a1,1:"
announce_block "create/params/seq_params/kind.arithmetic/roundtrip: err"
expect 2 ./main.py create "s0 a1,1:x"

announce_block "create/params/seq_params/kind.random-cover/required: ok"
expect 0 ./main.py create "s0 r+,1-99,10"
announce_block "create/params/seq_params/kind.random-cover/required: err"
expect 2 ./main.py create "s0 r+1-99,10"
expect 2 ./main.py create "s0 r+,1-9910"
expect 2 ./main.py create "s0 r+1-9910"

announce_block "create/params/seq_params/kind.random-cover/required/operands: ok"
expect 0 ./main.py create "s900 r+,1-99,10"
expect 0 ./main.py create "s900 r-,1-99,10"
expect 1 ./main.py create "s900 r*,1-99,10" # TODO: create cover "*" and "/"
expect 1 ./main.py create "s900 r/,1-99,10" # TODO: create cover "*" and "/"
expect 0 ./main.py create "s900 r+-,1-99,10"
expect 1 ./main.py create "s900 r*-,1-99,10" # TODO: create cover "*" and "/"
expect 1 ./main.py create "s900 r/+,1-99,10" # TODO: create cover "*" and "/"
expect 1 ./main.py create "s900 r*+/,1-99,10" # TODO: create cover "*" and "/"
expect 1 ./main.py create "s900 r+-*/,1-99,10" # TODO: create cover "*" and "/"
expect 0 ./main.py create "s900 r+1,1-99,10"
expect 0 ./main.py create "s900 r+2,1-99,10"
expect 0 ./main.py create "s900 r+15,1-99,10"
expect 0 ./main.py create "s900 r+-2,1-99,10"
expect 0 ./main.py create "s900 r+2-,1-99,10"
expect 0 ./main.py create "s900 r+2-2,1-99,10"
expect 0 ./main.py create "s900 r+2-3,1-99,10"
announce_block "create/params/seq_params/kind.random-cover/required/operands: err"
expect 2 ./main.py create "s900 r,1-99,10"
expect 2 ./main.py create "s900 r++,1-99,10"
expect 2 ./main.py create "s900 rx,1-99,10"
expect 2 ./main.py create "s900 r+x,1-99,10"
expect 2 ./main.py create "s900 rx-,1-99,10"
expect 2 ./main.py create "s900 r+0,1-99,10"
expect 2 ./main.py create "s900 r+1.2,1-99,10"

announce_block "create/params/seq_params/kind.random-cover/required/range: ok"
expect 0 ./main.py create "s0 r+,1-99,10"
announce_block "create/params/seq_params/kind.random-cover/required/range: err"
expect 2 ./main.py create "s0 r+,0-99,10"
expect 2 ./main.py create "s0 r+,-1-99,10"
expect 2 ./main.py create "s0 r+,-1.2-99,10"
expect 2 ./main.py create "s0 r+,1-99.2,10"
expect 2 ./main.py create "s0 r+,1x99,10"
expect 2 ./main.py create "s0 r+,_1-99,10"
expect 2 ./main.py create "s0 r+,1-99_,10"
expect 2 ./main.py create "s0 r+,_1-99_,10"

announce_block "create/params/seq_params/kind.random-cover/required/length: ok"
expect 0 ./main.py create "s0 r+,1-99,1"
expect 0 ./main.py create "s0 r+,1-99,10"
expect 1 ./main.py create "s0 c+,1-99" # TODO cover
expect 0 ./main.py create "s0 r+,1-99,1"
expect 0 ./main.py create "s0 r+,1-99,10"
announce_block "create/params/seq_params/kind.random-cover/required/length: err"
expect 2 ./main.py create "s0 r+,1-99,0"
expect 2 ./main.py create "s0 r+,1-99,1.2"
expect 2 ./main.py create "s0 r+,1-99,-1"
expect 2 ./main.py create "s0 r+,1-99,-1.2"
expect 2 ./main.py create "s0 r+,1-99,0"
expect 2 ./main.py create "s0 r+,1-99,1.2"
expect 2 ./main.py create "s0 r+,1-99,-1"
expect 2 ./main.py create "s0 r+,1-99,-1.2"
expect 2 ./main.py create "s0 r+,1-99,"
expect 2 ./main.py create "s0 r+,1-99,"
expect 2 ./main.py create "s0 r+,1-99,x"
expect 2 ./main.py create "s0 r+,1-99,x"

announce_block "create/params/seq_params/kind.random-cover/optional: ok"
expect 0 ./main.py create "s0 r+,1-99,10"
expect 0 ./main.py create "s0 r+,1-99,10:n"
expect 0 ./main.py create "s0 r+,1-99,10:.2"
expect 0 ./main.py create "s0 r+,1-99,10:.2%10"
expect 0 ./main.py create "s0 r+,1-99,10:<"
expect 0 ./main.py create "s0 r+,1-99,10:n.2"
expect 0 ./main.py create "s0 r+,1-99,10:n.2%10"
expect 0 ./main.py create "s0 r+,1-99,10:n<"
expect 0 ./main.py create "s0 r+,1-99,10:.2n"
expect 0 ./main.py create "s0 r+,1-99,10:.2<"
expect 0 ./main.py create "s0 r+,1-99,10:.2%10n"
expect 0 ./main.py create "s0 r+,1-99,10:.2%10<"
expect 0 ./main.py create "s0 r+,1-99,10:<n"
expect 0 ./main.py create "s0 r+,1-99,10:<.2"
expect 0 ./main.py create "s0 r+,1-99,10:<.2%10"
expect 0 ./main.py create "s0 r+,1-99,10:"
announce_block "create/params/seq_params/kind.random-cover/optional: err"
expect 2 ./main.py create "s0 r+,1-99,10:?"
expect 2 ./main.py create "s0 r+,1-99,10:.?"
expect 2 ./main.py create "s0 r+,1-99,10:.0"
expect 2 ./main.py create "s0 r+,1-99,10:.1.2"
expect 2 ./main.py create "s0 r+,1-99,10:.-1.2"
expect 2 ./main.py create "s0 r+,1-99,10:.2%?"
expect 2 ./main.py create "s0 r+,1-99,10:.2%0"
expect 2 ./main.py create "s0 r+,1-99,10:.2%101"
expect 2 ./main.py create "s0 r+,1-99,10:.2%1.2"
expect 2 ./main.py create "s0 r+,1-99,10:.2%-1"
expect 2 ./main.py create "s0 r+,1-99,10:.2%-1.2"
expect 2 ./main.py create "s0 r+,1-99,10n"
expect 2 ./main.py create "s0 r+,1-99,10.2"
expect 2 ./main.py create "s0 r+,1-99,10.2%10"
expect 2 ./main.py create "s0 r+,1-99,10<"
expect 2 ./main.py create "s0 r+,1-99,10:7n"
expect 2 ./main.py create "s0 r+,1-99,10:7.2"
expect 2 ./main.py create "s0 r+,1-99,10:7.2%10"
expect 2 ./main.py create "s0 r+,1-99,10:7<"
expect 2 ./main.py create "s0 r+,1-99,10:xn"
expect 2 ./main.py create "s0 r+,1-99,10:x.2"
expect 2 ./main.py create "s0 r+,1-99,10:x.2%10"
expect 2 ./main.py create "s0 r+,1-99,10:x<"
expect 2 ./main.py create "s0 r+,1-99,10:?n"
expect 2 ./main.py create "s0 r+,1-99,10:?.2"
expect 2 ./main.py create "s0 r+,1-99,10:?.2%10"
expect 2 ./main.py create "s0 r+,1-99,10:?<"
expect 2 ./main.py create "s0 r+,1-99,10:nx"
expect 2 ./main.py create "s0 r+,1-99,10:.2x"
expect 2 ./main.py create "s0 r+,1-99,10:.2%10x"
expect 2 ./main.py create "s0 r+,1-99,10:<x"
